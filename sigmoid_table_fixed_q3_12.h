#ifndef SIGMOID_TABLE_FIXED_H
#define SIGMOID_TABLE_FIXED_H

#include <stdint.h>
// Q3.12 sigmoid table using accurate fixed-point indexing

#define SIGMOID_MIN_FP (-32768)  // Q3.12
#define SIGMOID_MAX_FP (32768)  // Q3.12
#define SIGMOID_TABLE_SIZE (1601)
#define SIGMOID_RECIP_STEP_Q16 (6553600)  // 1/step in Q16.16

static const int16_t sigmoid_table[SIGMOID_TABLE_SIZE] = {
  1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 
  2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
  2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
  2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
  2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 
  3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 
  3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 
  3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 
  4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 
  4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 
  5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 
  5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 
  6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 
  7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 
  7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 
  8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 
  9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 
  11, 11, 11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 
  12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13, 
  13, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 
  15, 15, 15, 16, 16, 16, 16, 16, 16, 17, 17, 17, 
  17, 17, 17, 18, 18, 18, 18, 18, 18, 19, 19, 19, 
  19, 19, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 
  22, 22, 22, 22, 22, 23, 23, 23, 23, 24, 24, 24, 
  24, 25, 25, 25, 25, 26, 26, 26, 26, 27, 27, 27, 
  27, 28, 28, 28, 29, 29, 29, 29, 30, 30, 30, 31, 
  31, 31, 32, 32, 32, 32, 33, 33, 33, 34, 34, 34, 
  35, 35, 35, 36, 36, 37, 37, 37, 38, 38, 38, 39, 
  39, 40, 40, 40, 41, 41, 42, 42, 42, 43, 43, 44, 
  44, 45, 45, 45, 46, 46, 47, 47, 48, 48, 49, 49, 
  50, 50, 51, 51, 52, 52, 53, 53, 54, 54, 55, 55, 
  56, 56, 57, 58, 58, 59, 59, 60, 61, 61, 62, 62, 
  63, 64, 64, 65, 65, 66, 67, 67, 68, 69, 69, 70, 
  71, 72, 72, 73, 74, 74, 75, 76, 77, 77, 78, 79, 
  80, 80, 81, 82, 83, 84, 85, 85, 86, 87, 88, 89, 
  90, 91, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 
  101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 
  113, 114, 115, 117, 118, 119, 120, 121, 122, 124, 125, 126, 
  127, 128, 130, 131, 132, 134, 135, 136, 137, 139, 140, 142, 
  143, 144, 146, 147, 149, 150, 151, 153, 154, 156, 157, 159, 
  160, 162, 164, 165, 167, 168, 170, 172, 173, 175, 177, 178, 
  180, 182, 183, 185, 187, 189, 191, 192, 194, 196, 198, 200, 
  202, 204, 206, 208, 210, 212, 214, 216, 218, 220, 222, 224, 
  226, 228, 230, 233, 235, 237, 239, 242, 244, 246, 248, 251, 
  253, 256, 258, 260, 263, 265, 268, 270, 273, 275, 278, 281, 
  283, 286, 289, 291, 294, 297, 299, 302, 305, 308, 311, 314, 
  317, 319, 322, 325, 328, 331, 334, 338, 341, 344, 347, 350, 
  353, 357, 360, 363, 367, 370, 373, 377, 380, 384, 387, 391, 
  394, 398, 401, 405, 409, 412, 416, 420, 424, 427, 431, 435, 
  439, 443, 447, 451, 455, 459, 463, 467, 471, 476, 480, 484, 
  488, 493, 497, 501, 506, 510, 515, 519, 524, 528, 533, 538, 
  542, 547, 552, 557, 561, 566, 571, 576, 581, 586, 591, 596, 
  601, 606, 612, 617, 622, 627, 633, 638, 643, 649, 654, 660, 
  665, 671, 677, 682, 688, 694, 700, 705, 711, 717, 723, 729, 
  735, 741, 747, 753, 760, 766, 772, 778, 785, 791, 797, 804, 
  810, 817, 823, 830, 837, 843, 850, 857, 864, 870, 877, 884, 
  891, 898, 905, 912, 919, 926, 934, 941, 948, 955, 963, 970, 
  978, 985, 993, 1000, 1008, 1015, 1023, 1031, 1038, 1046, 1054, 1062, 
  1070, 1078, 1086, 1094, 1102, 1110, 1118, 1126, 1134, 1142, 1151, 1159, 
  1167, 1176, 1184, 1192, 1201, 1209, 1218, 1226, 1235, 1244, 1252, 1261, 
  1270, 1279, 1287, 1296, 1305, 1314, 1323, 1332, 1341, 1350, 1359, 1368, 
  1377, 1386, 1396, 1405, 1414, 1423, 1433, 1442, 1451, 1461, 1470, 1480, 
  1489, 1499, 1508, 1518, 1527, 1537, 1546, 1556, 1566, 1575, 1585, 1595, 
  1605, 1614, 1624, 1634, 1644, 1654, 1663, 1673, 1683, 1693, 1703, 1713, 
  1723, 1733, 1743, 1753, 1763, 1773, 1783, 1793, 1803, 1814, 1824, 1834, 
  1844, 1854, 1864, 1874, 1885, 1895, 1905, 1915, 1925, 1935, 1946, 1956, 
  1966, 1976, 1987, 1997, 2007, 2017, 2028, 2038, 2048, 2058, 2068, 2079, 
  2089, 2099, 2109, 2120, 2130, 2140, 2150, 2161, 2171, 2181, 2191, 2201, 
  2211, 2222, 2232, 2242, 2252, 2262, 2272, 2282, 2293, 2303, 2313, 2323, 
  2333, 2343, 2353, 2363, 2373, 2383, 2393, 2403, 2413, 2423, 2433, 2442, 
  2452, 2462, 2472, 2482, 2491, 2501, 2511, 2521, 2530, 2540, 2550, 2559, 
  2569, 2578, 2588, 2597, 2607, 2616, 2626, 2635, 2645, 2654, 2663, 2673, 
  2682, 2691, 2700, 2710, 2719, 2728, 2737, 2746, 2755, 2764, 2773, 2782, 
  2791, 2800, 2809, 2817, 2826, 2835, 2844, 2852, 2861, 2870, 2878, 2887, 
  2895, 2904, 2912, 2920, 2929, 2937, 2945, 2954, 2962, 2970, 2978, 2986, 
  2994, 3002, 3010, 3018, 3026, 3034, 3042, 3050, 3058, 3065, 3073, 3081, 
  3088, 3096, 3103, 3111, 3118, 3126, 3133, 3141, 3148, 3155, 3162, 3170, 
  3177, 3184, 3191, 3198, 3205, 3212, 3219, 3226, 3232, 3239, 3246, 3253, 
  3259, 3266, 3273, 3279, 3286, 3292, 3299, 3305, 3311, 3318, 3324, 3330, 
  3336, 3343, 3349, 3355, 3361, 3367, 3373, 3379, 3385, 3391, 3396, 3402, 
  3408, 3414, 3419, 3425, 3431, 3436, 3442, 3447, 3453, 3458, 3463, 3469, 
  3474, 3479, 3484, 3490, 3495, 3500, 3505, 3510, 3515, 3520, 3525, 3530, 
  3535, 3539, 3544, 3549, 3554, 3558, 3563, 3568, 3572, 3577, 3581, 3586, 
  3590, 3595, 3599, 3603, 3608, 3612, 3616, 3620, 3625, 3629, 3633, 3637, 
  3641, 3645, 3649, 3653, 3657, 3661, 3665, 3669, 3672, 3676, 3680, 3684, 
  3687, 3691, 3695, 3698, 3702, 3705, 3709, 3712, 3716, 3719, 3723, 3726, 
  3729, 3733, 3736, 3739, 3743, 3746, 3749, 3752, 3755, 3758, 3762, 3765, 
  3768, 3771, 3774, 3777, 3779, 3782, 3785, 3788, 3791, 3794, 3797, 3799, 
  3802, 3805, 3807, 3810, 3813, 3815, 3818, 3821, 3823, 3826, 3828, 3831, 
  3833, 3836, 3838, 3840, 3843, 3845, 3848, 3850, 3852, 3854, 3857, 3859, 
  3861, 3863, 3866, 3868, 3870, 3872, 3874, 3876, 3878, 3880, 3882, 3884, 
  3886, 3888, 3890, 3892, 3894, 3896, 3898, 3900, 3902, 3904, 3905, 3907, 
  3909, 3911, 3913, 3914, 3916, 3918, 3919, 3921, 3923, 3924, 3926, 3928, 
  3929, 3931, 3932, 3934, 3936, 3937, 3939, 3940, 3942, 3943, 3945, 3946, 
  3947, 3949, 3950, 3952, 3953, 3954, 3956, 3957, 3959, 3960, 3961, 3962, 
  3964, 3965, 3966, 3968, 3969, 3970, 3971, 3972, 3974, 3975, 3976, 3977, 
  3978, 3979, 3981, 3982, 3983, 3984, 3985, 3986, 3987, 3988, 3989, 3990, 
  3991, 3992, 3993, 3994, 3995, 3996, 3997, 3998, 3999, 4000, 4001, 4002, 
  4003, 4004, 4005, 4005, 4006, 4007, 4008, 4009, 4010, 4011, 4011, 4012, 
  4013, 4014, 4015, 4016, 4016, 4017, 4018, 4019, 4019, 4020, 4021, 4022, 
  4022, 4023, 4024, 4024, 4025, 4026, 4027, 4027, 4028, 4029, 4029, 4030, 
  4031, 4031, 4032, 4032, 4033, 4034, 4034, 4035, 4035, 4036, 4037, 4037, 
  4038, 4038, 4039, 4040, 4040, 4041, 4041, 4042, 4042, 4043, 4043, 4044, 
  4044, 4045, 4045, 4046, 4046, 4047, 4047, 4048, 4048, 4049, 4049, 4050, 
  4050, 4051, 4051, 4051, 4052, 4052, 4053, 4053, 4054, 4054, 4054, 4055, 
  4055, 4056, 4056, 4056, 4057, 4057, 4058, 4058, 4058, 4059, 4059, 4059, 
  4060, 4060, 4061, 4061, 4061, 4062, 4062, 4062, 4063, 4063, 4063, 4064, 
  4064, 4064, 4064, 4065, 4065, 4065, 4066, 4066, 4066, 4067, 4067, 4067, 
  4067, 4068, 4068, 4068, 4069, 4069, 4069, 4069, 4070, 4070, 4070, 4070, 
  4071, 4071, 4071, 4071, 4072, 4072, 4072, 4072, 4073, 4073, 4073, 4073, 
  4074, 4074, 4074, 4074, 4074, 4075, 4075, 4075, 4075, 4075, 4076, 4076, 
  4076, 4076, 4076, 4077, 4077, 4077, 4077, 4077, 4078, 4078, 4078, 4078, 
  4078, 4078, 4079, 4079, 4079, 4079, 4079, 4079, 4080, 4080, 4080, 4080, 
  4080, 4080, 4081, 4081, 4081, 4081, 4081, 4081, 4081, 4082, 4082, 4082, 
  4082, 4082, 4082, 4082, 4083, 4083, 4083, 4083, 4083, 4083, 4083, 4084, 
  4084, 4084, 4084, 4084, 4084, 4084, 4084, 4084, 4085, 4085, 4085, 4085, 
  4085, 4085, 4085, 4085, 4085, 4086, 4086, 4086, 4086, 4086, 4086, 4086, 
  4086, 4086, 4086, 4087, 4087, 4087, 4087, 4087, 4087, 4087, 4087, 4087, 
  4087, 4087, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 4088, 
  4088, 4088, 4088, 4089, 4089, 4089, 4089, 4089, 4089, 4089, 4089, 4089, 
  4089, 4089, 4089, 4089, 4089, 4090, 4090, 4090, 4090, 4090, 4090, 4090, 
  4090, 4090, 4090, 4090, 4090, 4090, 4090, 4090, 4090, 4090, 4091, 4091, 
  4091, 4091, 4091, 4091, 4091, 4091, 4091, 4091, 4091, 4091, 4091, 4091, 
  4091, 4091, 4091, 4091, 4091, 4091, 4092, 4092, 4092, 4092, 4092, 4092, 
  4092, 4092, 4092, 4092, 4092, 4092, 4092, 4092, 4092, 4092, 4092, 4092, 
  4092, 4092, 4092, 4092, 4092, 4092, 4092, 4093, 4093, 4093, 4093, 4093, 
  4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 
  4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 4093, 
  4093, 4093, 4093, 4093, 4093, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 
  4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 
  4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 
  4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 
  4094, 4094, 4094, 4094, 4094, 4094, 4094, 4094, 4095, 4095, 4095, 4095, 
  4095, 4095, 4095, 4095, 4095
};


static inline int16_t sigmoid_lookup_q3_12(int16_t x_fp) {
    if (x_fp <= SIGMOID_MIN_FP) return 0;
    if (x_fp >= SIGMOID_MAX_FP) return 4096;  // 1.0 in Q3.12

    int32_t offset = (int32_t)(x_fp - SIGMOID_MIN_FP);
    int32_t index_fp = (offset * SIGMOID_RECIP_STEP_Q16);  // Q3.12 * Q16.16 = Q19.28
    int32_t index = index_fp >> 16;        // Integer part
    int32_t frac = index_fp & 0xFFFF;      // Fractional part

    int16_t y0 = sigmoid_table[index];
    int16_t y1 = sigmoid_table[index + 1];

    int32_t diff = (int32_t)(y1 - y0);
    int32_t interp = y0 + ((diff * frac) >> 16);  // Linear interpolation

    return (int16_t)interp;
}

#endif // SIGMOID_TABLE_FIXED_H